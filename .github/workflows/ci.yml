name: CI

on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
    inputs:
      skip_gpu:
        description: "Skip GPU smoke test"
        required: false
        default: false
        type: boolean
      gpu_type:
        description: "RunPod GPU type ID"
        required: false
        default: "NVIDIA A100 80GB PCIe"
        type: string
      total_timesteps:
        description: "Total timesteps for smoke test"
        required: false
        default: "20000"
        type: string

permissions:
  contents: read
  pull-requests: write

env:
  WANDB_CI_PROJECT: factorion
  PYTHON_VERSION: "3.11"

jobs:
  # ──────────────────────────────────────────────
  # Job 0: Decide whether GPU tests should run
  # ──────────────────────────────────────────────
  check-gpu-trigger:
    runs-on: ubuntu-latest
    outputs:
      run_gpu: ${{ steps.check.outputs.run_gpu }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for GPU test triggers
        id: check
        env:
          EVENT_NAME: ${{ github.event_name }}
          SKIP_GPU: ${{ inputs.skip_gpu || 'false' }}
        run: |
          RUN_GPU=false

          # 1. workflow_dispatch: always run GPU tests (unless skip_gpu)
          if [ "$EVENT_NAME" = "workflow_dispatch" ] && [ "$SKIP_GPU" != "true" ]; then
            echo "::notice::GPU tests triggered via workflow_dispatch"
            RUN_GPU=true
          fi

          # 2. Check PR labels for gpu-test
          LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'
          if echo "$LABELS" | grep -qi 'gpu-test'; then
            echo "::notice::GPU tests triggered via PR label"
            RUN_GPU=true
          fi

          echo "run_gpu=$RUN_GPU" >> "$GITHUB_OUTPUT"
          echo "GPU tests will run: $RUN_GPU"

  # ──────────────────────────────────────────────
  # Job 1: Lint
  # ──────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install ruff
        run: pip install ruff==0.11.8
      - name: Run ruff
        run: ruff check .

  # ──────────────────────────────────────────────
  # Job 2: Python tests
  # ──────────────────────────────────────────────
  python-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: factorion_rs
      - name: Install dependencies
        run: |
          pip install pytest pytest-timeout
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install numpy gymnasium networkx tyro pydantic marimo maturin tqdm matplotlib pandas plotly wandb
      - name: Build and install factorion_rs
        run: cd factorion_rs && maturin build --release --out dist && pip install dist/*.whl
      - name: Run Python tests
        env:
          WANDB_MODE: disabled
          WANDB_DISABLED: "true"
        run: |
          if compgen -G "tests/test_*.py" > /dev/null 2>&1 || compgen -G "tests/*_test.py" > /dev/null 2>&1; then
            pytest tests/ -v --timeout=120
          else
            echo "::notice::No Python test files found yet. Add tests to tests/ directory."
          fi

  # ──────────────────────────────────────────────
  # Job 3: Rust tests
  # ──────────────────────────────────────────────
  rust-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Check for Rust code
        id: check-rust
        run: |
          if [ -f factorion_rs/Cargo.toml ]; then
            echo "has_rust=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_rust=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No Cargo.toml found. Skipping Rust tests."
          fi
      - name: Install Rust toolchain
        if: steps.check-rust.outputs.has_rust == 'true'
        uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        if: steps.check-rust.outputs.has_rust == 'true'
        with:
          workspaces: factorion_rs
      - name: Run Rust tests
        if: steps.check-rust.outputs.has_rust == 'true'
        run: cd factorion_rs && cargo test --no-default-features

  # ──────────────────────────────────────────────
  # Job 4: GPU smoke test (RunPod A100)
  # ──────────────────────────────────────────────
  gpu-smoke-test:
    needs: [check-gpu-trigger]
    if: ${{ needs.check-gpu-trigger.outputs.run_gpu == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install CI dependencies
        run: pip install runpod wandb

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.RUNPOD_SSH_PRIVATE_KEY }}" > ~/.ssh/runpod_ci
          chmod 600 ~/.ssh/runpod_ci
          # Disable strict host checking for RunPod SSH
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF

      - name: Create RunPod instance
        id: create-pod
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python scripts/ci/runpod_create.py \
            --gpu-type "${{ inputs.gpu_type || 'NVIDIA A100 80GB PCIe' }}" \
            --output-file /tmp/pod_info.json

          echo "pod_id=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['pod_id'])")" >> "$GITHUB_OUTPUT"

      - name: Wait for SSH readiness
        run: |
          SSH_HOST=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['ssh_host'])")
          SSH_PORT=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['ssh_port'])")
          echo "Waiting for SSH on root@${SSH_HOST}:${SSH_PORT}..."
          for i in $(seq 1 30); do
            if ssh -i ~/.ssh/runpod_ci -p "$SSH_PORT" -o ConnectTimeout=5 root@"$SSH_HOST" echo "SSH ready" 2>/dev/null; then
              echo "SSH connection established"
              exit 0
            fi
            echo "  Attempt $i/30 - retrying in 10s..."
            sleep 10
          done
          echo "::error::SSH connection timed out"
          exit 1

      - name: Transfer code to pod
        run: |
          SSH_HOST=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['ssh_host'])")
          SSH_PORT=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['ssh_port'])")

          # Create a tarball of the repo (excluding .git and large dirs)
          tar czf /tmp/factorion.tar.gz \
            --exclude='.git' \
            --exclude='artifacts' \
            --exclude='wandb' \
            --exclude='runs' \
            --exclude='videos' \
            --exclude='__pycache__' \
            -C "$GITHUB_WORKSPACE" .

          # Transfer to pod
          scp -i ~/.ssh/runpod_ci -P "$SSH_PORT" /tmp/factorion.tar.gz root@"$SSH_HOST":/workspace/factorion.tar.gz

          # Extract on pod
          ssh -i ~/.ssh/runpod_ci -p "$SSH_PORT" root@"$SSH_HOST" << 'SETUP'
            mkdir -p /workspace/factorion
            tar xzf /workspace/factorion.tar.gz -C /workspace/factorion
            ls -la /workspace/factorion/
          SETUP

      - name: Run smoke test on GPU
        id: smoke-test
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
        run: |
          SSH_HOST=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['ssh_host'])")
          SSH_PORT=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['ssh_port'])")
          POD_ID=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['pod_id'])")
          PR_NUMBER="${{ github.event.pull_request.number || 'manual' }}"
          TOTAL_TIMESTEPS="${{ inputs.total_timesteps || '20000' }}"

          # Transfer the smoke test script and run it
          scp -i ~/.ssh/runpod_ci -P "$SSH_PORT" scripts/ci/gpu_smoke_test.sh root@"$SSH_HOST":/workspace/gpu_smoke_test.sh

          ssh -i ~/.ssh/runpod_ci -p "$SSH_PORT" root@"$SSH_HOST" \
            WANDB_API_KEY="$WANDB_API_KEY" \
            WANDB_PROJECT="${{ env.WANDB_CI_PROJECT }}" \
            TOTAL_TIMESTEPS="$TOTAL_TIMESTEPS" \
            PR_NUMBER="$PR_NUMBER" \
            COMMIT_SHA="$GITHUB_SHA" \
            RUNPOD_API_KEY="$RUNPOD_API_KEY" \
            RUNPOD_POD_ID="$POD_ID" \
            bash /workspace/gpu_smoke_test.sh

      - name: Fetch summary from pod
        if: success()
        run: |
          SSH_HOST=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['ssh_host'])")
          SSH_PORT=$(python -c "import json; print(json.load(open('/tmp/pod_info.json'))['ssh_port'])")
          scp -i ~/.ssh/runpod_ci -P "$SSH_PORT" root@"$SSH_HOST":/workspace/summary.md /tmp/summary.md 2>/dev/null || echo "No summary file found on pod"

      - name: Post results to PR
        if: success() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/summary.md ]; then
            gh pr comment "${{ github.event.pull_request.number }}" --body "$(cat /tmp/summary.md)"
          else
            echo "::warning::No summary.md to post"
          fi

      - name: Destroy RunPod instance
        if: always()
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
        run: |
          if [ -f /tmp/pod_info.json ]; then
            python scripts/ci/runpod_destroy.py --pod-info-file /tmp/pod_info.json
          else
            echo "::warning::No pod info file found, nothing to clean up"
          fi

